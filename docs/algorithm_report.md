# 워크 핸들링 최적화 알고리즘 리포트

## 1. 개요

### 1.1 목적
스마트 WMS 갠트리 로봇 창고 시스템의 워크 핸들링 알고리즘을 최적화하여,
**동일한 조건(미션 리스트)에서 갠트리 로봇의 총 이동거리를 최소화**한다.

### 1.2 대상 시스템
| 항목 | 사양 |
|------|------|
| 창고 규격 | 20 x 20 x 5 (열 x 행 x 높이) |
| 최대 적재량 | 1,996개 |
| 입출고구 위치 | 원점 (0, 0, 0) |
| 적재 영역 | (1,1,1) ~ (20,20,5) |
| 품목 종류 | 4종 (01, 02, 03, 04) |
| 적재 방식 | LIFO 스택 (같은 열에 수직 적재) |

### 1.3 평가 기준
- **시간 점수 (70%)**: 총 이동거리 기반 (낮을수록 우수)
- **위치 점수 (30%)**: 적재 높이 균일성 (표준편차가 낮을수록 우수)
- **종합 점수**: 시간점수 x 0.7 + 위치점수 x 0.3

---

## 2. As-Is 분석: FF (First-Fit) 알고리즘

### 2.1 입고 위치 결정
```
입고 요청 → 가장 낮은 높이의 빈자리 중 좌표 순서대로 첫 번째 선택
```
- 모든 품목이 **동일한 기준**으로 배치
- 출고 빈도, 출고구와의 거리 **고려 없음**
- 좌표 (0,0) → (1,0) → ... → (19,19) 순서로 채움

### 2.2 출고 대상 선택
```
출고 요청 → 해당 품목의 등록순 첫 번째 lot 선택
```
- 스택 내 위치(깊이), 출고구와의 거리 **고려 없음**
- 위에 다른 아이템이 쌓여 있어도 그대로 선택 → 블로킹 아이템 재배치 발생

### 2.3 블로킹 아이템 재배치
```
블로킹 아이템 → 가장 낮은 높이의 첫 번째 빈자리로 이동
```
- 재배치 시에도 빈도 고려 없음

### 2.4 문제점
1. 출고 빈도가 높은 품목이 창고 안쪽 깊숙이 배치될 수 있음
2. 출고 시 블로킹 아이템이 많아 불필요한 이동 발생
3. 모든 품목이 고르게 퍼져 평균 이동거리가 큼

---

## 3. To-Be 설계: 빈도 기반 배치 알고리즘

### 3.1 핵심 아이디어

**출고 빈도가 높은 품목은 접근이 빠른 위치에, 낮은 품목은 깊숙한 위치에 배치한다.**

```
              출고구 [0,0,0]
                 ↑ 가까움
   (1,1)  (2,1)  ...  (20,1)       z=5 (위) ← HOT 품목
   (1,2)  (2,2)  ...  (20,2)       z=4
    ...                 ...         z=3
   (1,20) (2,20) ...  (20,20)      z=2
                 ↓ 멀음             z=1 (아래) ← COLD 품목
```

### 3.2 비용 함수

각 위치 (x, y, z)에 대해 **접근 비용**을 계산한다:

```
cost(x, y, z) = XY거리 + 높이패널티
              = sqrt((x + ox)^2 + (y + oy)^2) + (HEIGHT - 1 - z)
```

여기서:
- `ox, oy` = 적재 영역의 원점 오프셋 (1, 1)
- `HEIGHT` = 최대 적재 높이 (5)
- z가 높을수록 높이패널티가 작아짐 (빠른 접근)
- x, y가 작을수록 XY거리가 작아짐 (출고구 근접)

### 3.3 입고 위치 결정 (개선)

```
입고 요청 → 품목별 출고 빈도 점수 계산 (freq_score: 0.0 ~ 1.0)
         → freq_score >= 0.5 (HOT): cost 최소 위치 선택 → 위쪽 + 출고구 가까이
         → freq_score <  0.5 (COLD): cost 최대 위치 선택 → 아래쪽 + 출고구 멀리
```

**탐색 최적화:**
- HOT 품목: 높은 z부터 탐색, `z_cost >= best_cost`이면 조기 종료
- COLD 품목: 낮은 z부터 탐색
- XY 거리는 사전 계산 테이블 참조 (O(1))

### 3.4 출고 대상 선택 (개선)

```
출고 요청 → 같은 품목의 모든 lot 스캔
         → 정렬 기준: (블로킹 수 ASC, 출고구 거리 ASC)
         → 블로킹 최소 + 출고구 최근접 lot 선택
```

**선택 기준:**

| 우선순위 | 기준 | 설명 |
|----------|------|------|
| 1순위 | 블로킹 아이템 수 | 위에 쌓인 개수 (0이 최우선) |
| 2순위 | 출고구 XY 거리 | 가까울수록 우선 |

### 3.5 블로킹 아이템 재배치 (개선)

```
블로킹 아이템 → 해당 아이템의 출고 빈도에 맞는 위치로 재배치
             → HOT 아이템이면 → 위쪽 + 출고구 가까이
             → COLD 아이템이면 → 아래쪽 + 출고구 멀리
```

재배치가 곧 **창고 정리**가 됨 → 운영할수록 배치가 최적화됨

---

## 4. 빈도 파악 방식: RL vs LA

### 4.1 RL (Real-time Learning) - 실시간 학습

```
freq_score = 해당 품목의 출고 횟수 / 전체 품목 중 최대 출고 횟수
```

| 특성 | 내용 |
|------|------|
| 데이터 소스 | 운영 중 누적된 실제 출고 이력 |
| 초기 상태 | 0.5 (중립, FF와 유사하게 동작) |
| 학습 곡선 | 출고가 쌓일수록 정확해짐 |
| 장점 | 실제 환경에 적용 가능, 패턴 변화에 적응 |
| 단점 | 초반에는 데이터 부족으로 최적화 미흡 |

### 4.2 LA (Lookahead) - 미리보기

```
freq_score = 미션 리스트에서 사전 분석된 출고 횟수 / 최대 출고 횟수
```

| 특성 | 내용 |
|------|------|
| 데이터 소스 | 미션 리스트 사전 분석 (전체 OUT 미션 집계) |
| 초기 상태 | 처음부터 정확한 빈도 보유 |
| 장점 | 이론적 최적, 첫 미션부터 최적 배치 |
| 단점 | 미션 리스트를 사전에 알아야 함 (테스트/벤치마크 전용) |

---

## 5. 벤치마크 결과

### 5.1 테스트 환경
- 미션 수: 100,000건 (입고 + 출고 + 대기)
- 모드: N (시뮬레이션 없음, 알고리즘 순수 성능 측정)
- SEED 2종: 123456, 12345

### 5.2 SEED = 123456

| 항목 | FF (기본) | RL (실시간학습) | LA (미리보기) |
|------|-----------|----------------|--------------|
| XY 이동거리 | 1,611,137 | 236,980 | 237,005 |
| Z 이동거리 | 584,265 | 337,134 | 337,152 |
| **총 이동거리** | **2,195,402** | **574,114** | **574,157** |
| 높이 표준편차 | 0.2683 | 0.2387 | 0.2387 |
| 시간 점수 | 100.00% | 100.00% | 100.00% |
| 위치 점수 | 3.73 | 4.19 | 4.19 |
| **종합 점수** | **181.81%** | **195.66%** | **195.66%** |
| 처리 시간 | 46.4s | 58.2s | 54.0s |

### 5.3 SEED = 12345

| 항목 | FF (기본) | RL (실시간학습) | LA (미리보기) |
|------|-----------|----------------|--------------|
| XY 이동거리 | 1,626,380 | 251,579 | 250,402 |
| Z 이동거리 | 587,616 | 339,936 | 339,837 |
| **총 이동거리** | **2,213,996** | **591,515** | **590,239** |
| 높이 표준편차 | 0.1654 | 0.1317 | 0.1495 |
| 시간 점수 | 100.00% | 100.00% | 100.00% |
| 위치 점수 | 6.05 | 7.59 | 6.69 |
| **종합 점수** | **251.42%** | **297.80%** | **270.70%** |
| 처리 시간 | 51.9s | 66.8s | 61.7s |

### 5.4 개선율 요약

| 지표 | SEED=123456 | SEED=12345 | 평균 |
|------|-------------|------------|------|
| XY 이동거리 감소 | **85.3%** | **84.5%** | **84.9%** |
| Z 이동거리 감소 | **42.3%** | **42.1%** | **42.2%** |
| 총 이동거리 감소 | **73.8%** | **73.3%** | **73.6%** |
| 높이 균일성 개선 | **11.0%** | **20.4%** | **15.7%** |

---

## 6. 분석

### 6.1 XY 이동거리 85% 감소의 원인

FF에서는 모든 품목이 좌표 순서대로 배치되어 평균 XY 거리가 약 15 단위였다.
RL/LA에서는 출고 빈도가 높은 품목이 출고구 인근 (0~3 범위)에 집중 배치되어
평균 XY 거리가 약 2~3 단위로 감소하였다.

### 6.2 스마트 출고 선택의 효과

FF에서는 등록순 첫 번째 lot을 선택하여 평균 2~3개의 블로킹 아이템 재배치가 발생했다.
RL/LA에서는 스택 최상단(블로킹 0) + 출고구 근접 lot을 우선 선택하여
블로킹 재배치가 크게 감소하였다.

### 6.3 RL과 LA의 성능 비교

- SEED=123456: RL과 LA가 거의 동일한 성능 (총 이동거리 차이 0.01%)
- SEED=12345: RL이 LA보다 종합 점수에서 우수 (297.80% vs 270.70%)
  - RL의 높이 균일성(0.1317)이 LA(0.1495)보다 우수
  - RL은 운영 중 학습하며 배치를 점진적으로 최적화하기 때문

### 6.4 처리 속도

RL/LA는 FF 대비 약 20~30% 더 느리다 (위치 스코어링 연산 추가).
그러나 실제 RoboDK 시뮬레이션 모드(S)에서는 로봇 동작 시간이 지배적이므로
알고리즘 연산 시간 차이는 무시할 수 있다.

---

## 7. 결론 및 권장사항

### 7.1 결론

| 알고리즘 | 적용 환경 | 총 이동거리 감소 | 권장 |
|----------|-----------|-----------------|------|
| **RL** | 실제 운영 환경 | **73~74%** | **권장** |
| **LA** | 테스트/벤치마크 | **73~74%** | 테스트용 |
| FF | 기본/비교 기준 | - | 기준값 |

### 7.2 권장사항

1. **실제 운영에는 RL 모드 권장**
   - 미션 리스트 사전 정보 불필요
   - 운영하면서 자동으로 최적화됨
   - 출고 패턴 변화에 실시간 적응

2. **벤치마크/평가에는 LA 모드 활용**
   - 이론적 최적 배치로 알고리즘 상한선 확인 가능

3. **향후 개선 방향**
   - 시간 감쇠(time decay) 적용: 최근 출고 이력에 가중치 부여
   - 품목별 구역 예약: 특정 품목 전용 구역 지정
   - 배치 재정렬(defragmentation): 유휴 시간에 기존 배치 최적화

---

## 부록: 실행 방법

```bash
# 알고리즘 테스트 (N 모드)
python main.py
# → n 선택 → SEED 입력 → FF/RL/LA 선택

# 시뮬레이션 테스트 (S 모드, RoboDK 필요)
# Windows: python plc_motion006.py (먼저 실행)
# WSL:     python main.py → s → SEED → FF/RL/LA
```

---

*작성일: 2026-02-25*
*시스템: DT_Gantry_Robot_WareHouse v0.2*
